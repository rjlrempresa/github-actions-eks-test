name: ðŸš€ Test EKS Runner - Full CI/CD

on:
  workflow_dispatch:  # Solo manual
  
env:
  APP_NAME: test-app
  NAMESPACE: default

jobs:
  build-and-deploy:
    name: Build and Deploy Test App
    runs-on: [self-hosted, linux, eks]
    
    steps:
    - name: ðŸ“‹ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸ—ï¸ Create test application
      run: |
        echo "=== CREATING TEST APP ==="
        mkdir -p test-app
        cat > test-app/index.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
            <title>EKS Runner Test</title>
        </head>
        <body>
            <h1>ðŸŽ‰ Hello from EKS Runner!</h1>
            <p>This app was deployed by GitHub Actions running on EKS</p>
            <p>Build time: $(date)</p>
            <p>Runner: $(hostname)</p>
        </body>
        </html>
        EOF
        
        cat > test-app/Dockerfile << 'EOF'
        FROM nginx:alpine
        COPY index.html /usr/share/nginx/html/
        EXPOSE 80
        EOF
        
        echo "âœ… Test app created"
        
    - name: ðŸ³ Build Docker image (simulate)
      run: |
        echo "=== SIMULATING DOCKER BUILD ==="
        echo "docker build -t $APP_NAME:$GITHUB_SHA test-app/"
        echo "âœ… Docker build simulated (no Docker daemon available)"
        
    - name: ðŸ“¦ Create Kubernetes manifests
      run: |
        echo "=== CREATING K8S MANIFESTS ==="
        cat > k8s-deployment.yaml << EOF
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: $APP_NAME
          namespace: $NAMESPACE
          labels:
            app: $APP_NAME
            deployed-by: github-actions
            runner: eks
        spec:
          replicas: 1
          selector:
            matchLabels:
              app: $APP_NAME
          template:
            metadata:
              labels:
                app: $APP_NAME
            spec:
              containers:
              - name: $APP_NAME
                image: nginx:alpine
                ports:
                - containerPort: 80
                env:
                - name: DEPLOYED_BY
                  value: "GitHub Actions on EKS"
                - name: BUILD_SHA
                  value: "$GITHUB_SHA"
        ---
        apiVersion: v1
        kind: Service
        metadata:
          name: $APP_NAME-service
          namespace: $NAMESPACE
        spec:
          selector:
            app: $APP_NAME
          ports:
          - port: 80
            targetPort: 80
          type: ClusterIP
        EOF
        
        echo "âœ… Kubernetes manifests created"
        
    - name: ðŸš€ Deploy to Kubernetes (dry-run)
      run: |
        echo "=== DEPLOYING TO KUBERNETES (DRY-RUN) ==="
        kubectl apply -f k8s-deployment.yaml --dry-run=client
        echo "âœ… Deployment dry-run successful"
        
    - name: ðŸ§¹ Cleanup test files
      run: |
        echo "=== CLEANING UP ==="
        rm -rf test-app/
        rm -f k8s-deployment.yaml
        echo "âœ… Cleanup completed"
        
    - name: ðŸ“Š Summary
      run: |
        echo "=== DEPLOYMENT SUMMARY ==="
        echo "âœ… App Name: $APP_NAME"
        echo "âœ… Namespace: $NAMESPACE"
        echo "âœ… Build SHA: $GITHUB_SHA"
        echo "âœ… Runner: $(hostname)"
        echo "âœ… Timestamp: $(date)"
        echo ""
        echo "ðŸŽ‰ Full CI/CD pipeline test completed successfully!"